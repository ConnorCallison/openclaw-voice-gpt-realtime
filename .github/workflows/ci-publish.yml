name: CI and ClawHub Publish

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        run: bun run typecheck

      - name: Verify version consistency
        shell: bash
        run: |
          set -euo pipefail
          PACKAGE_VERSION="$(bun -e "console.log(JSON.parse(await Bun.file('package.json').text()).version)")"
          PLUGIN_VERSION="$(bun -e "console.log(JSON.parse(await Bun.file('openclaw.plugin.json').text()).version)")"
          SKILL_VERSION="$(awk '/^version:/{print $2; exit}' SKILL.md)"

          if [[ "$PACKAGE_VERSION" != "$PLUGIN_VERSION" || "$PACKAGE_VERSION" != "$SKILL_VERSION" ]]; then
            echo "Version mismatch:"
            echo "  package.json: $PACKAGE_VERSION"
            echo "  openclaw.plugin.json: $PLUGIN_VERSION"
            echo "  SKILL.md: $SKILL_VERSION"
            exit 1
          fi

  publish:
    name: Publish to ClawHub
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Ensure CLAWHUB_TOKEN is set
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        shell: bash
        run: |
          if [[ -z "$CLAWHUB_TOKEN" ]]; then
            echo "Missing CLAWHUB_TOKEN secret."
            exit 1
          fi

      - name: Resolve package metadata
        id: meta
        shell: bash
        run: |
          echo "name=$(awk '/^name:/{print $2; exit}' SKILL.md)" >> "$GITHUB_OUTPUT"
          echo "version=$(awk '/^version:/{print $2; exit}' SKILL.md)" >> "$GITHUB_OUTPUT"

      - name: Login to ClawHub
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        run: bunx --bun clawhub login --token "$CLAWHUB_TOKEN" --no-input

      - name: Check existing release
        id: exists
        shell: bash
        run: |
          if bunx --bun clawhub inspect "${{ steps.meta.outputs.name }}" --version "${{ steps.meta.outputs.version }}" --json --no-input >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Version already published. Skipping."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish
        if: steps.exists.outputs.exists == 'false'
        run: bunx --bun clawhub publish . --version "${{ steps.meta.outputs.version }}" --no-input
