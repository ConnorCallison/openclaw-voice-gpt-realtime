name: CI and ClawHub Publish

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        run: bun run typecheck

      - name: Verify version consistency
        shell: bash
        run: |
          set -euo pipefail
          PACKAGE_VERSION="$(bun -e "console.log(JSON.parse(await Bun.file('package.json').text()).version)")"
          PLUGIN_VERSION="$(bun -e "console.log(JSON.parse(await Bun.file('openclaw.plugin.json').text()).version)")"
          SKILL_VERSION="$(awk '/^version:/{print $2; exit}' SKILL.md)"

          if [[ "$PACKAGE_VERSION" != "$PLUGIN_VERSION" || "$PACKAGE_VERSION" != "$SKILL_VERSION" ]]; then
            echo "Version mismatch:"
            echo "  package.json: $PACKAGE_VERSION"
            echo "  openclaw.plugin.json: $PLUGIN_VERSION"
            echo "  SKILL.md: $SKILL_VERSION"
            exit 1
          fi

  publish:
    name: Publish to ClawHub
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Ensure CLAWHUB_TOKEN is set
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        shell: bash
        run: |
          if [[ -z "$CLAWHUB_TOKEN" ]]; then
            echo "Missing CLAWHUB_TOKEN secret."
            exit 1
          fi

      - name: Resolve package metadata
        id: meta
        shell: bash
        run: |
          echo "name=$(awk '/^name:/{print $2; exit}' SKILL.md)" >> "$GITHUB_OUTPUT"
          echo "version=$(awk '/^version:/{print $2; exit}' SKILL.md)" >> "$GITHUB_OUTPUT"

      - name: Login to ClawHub
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        run: npx -y clawhub@latest login --token "$CLAWHUB_TOKEN" --no-input

      - name: Publish (with retry)
        shell: bash
        run: |
          set -euo pipefail

          MAX_ATTEMPTS=5
          SLEEP_SECONDS=15

          for ATTEMPT in $(seq 1 "$MAX_ATTEMPTS"); do
            echo "Publish attempt ${ATTEMPT}/${MAX_ATTEMPTS}"

            set +e
            OUTPUT="$(npx -y clawhub@latest publish . --version "${{ steps.meta.outputs.version }}" --no-input 2>&1)"
            EXIT_CODE=$?
            set -e

            echo "$OUTPUT"

            if [[ $EXIT_CODE -eq 0 ]]; then
              echo "Publish succeeded."
              exit 0
            fi

            if echo "$OUTPUT" | grep -qi "already exists"; then
              echo "Version is already published; treating as success."
              exit 0
            fi

            if echo "$OUTPUT" | grep -qi "Rate limit exceeded"; then
              if [[ "$ATTEMPT" -lt "$MAX_ATTEMPTS" ]]; then
                echo "Rate limited. Sleeping ${SLEEP_SECONDS}s before retry..."
                sleep "$SLEEP_SECONDS"
                SLEEP_SECONDS=$((SLEEP_SECONDS * 2))
                continue
              fi
            fi

            echo "Publish failed with a non-retryable error."
            exit $EXIT_CODE
          done

          echo "Publish failed after retries."
          exit 1
